<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC   "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mutedcritics.userStat.dao.UserTierStatsDAO">

    <select id="getTierStatistics" resultType="com.mutedcritics.dto.TierStatDTO">
        SELECT
            t.tier_name AS tierName,
            COUNT(DISTINCT t.user_id) AS userCount
        FROM
            tier r
        JOIN
            season s ON t.season_idx = s.season_idx
        JOIN
            user u ON t.user_id = u.user_id
        
        <if test="classification == 'MAIN_HERO'">
            JOIN (
                SELECT
                    user_id, heroes_idx
                FROM (
                    SELECT
                        mr.user_id,
                        mr.heroes_idx,
                        ROW_NUMBER() OVER (PARTITION BY mr.user_id ORDER BY COUNT(mr.heroes_idx) DESC) AS rn
                    FROM
                        match_result mr
                    JOIN
                        match_table m ON mr.match_idx = m.match_idx
                    WHERE
                        m.match_date BETWEEN (SELECT start_date FROM season WHERE season_idx = #{seasonId})
                        AND (SELECT end_date FROM season WHERE season_idx = #{seasonId})
                    GROUP BY
                        mr.user_id, mr.heroes_idx
                ) AS PlayCounts
                WHERE rn = 1
            ) AS main_hero ON u.user_id = main_hero.user_id
        </if>

        WHERE
            t.season_idx #{seasonId}
        <choose>
            <when test="classification == 'GENDER'">
                    AND u.user_gender = #{value}
            </when>
            <when test="classification == 'REGION'">
                    AND u.region = #{value}
            </when>
            <when test="classfication == 'VIP'">
                    AND u.vip_yn = b'1'
            </when>
            <when test="classfication == 'MAIN_HERO'">
                    AND main_hero.heroes_idx = #{value}
            </when>
        </choose>
    GROUP BY
        t.tier_name
    ORDER BY
        FIELD(t.tier_name, '언랭크드', '브론즈', '실버', '골드', '플래티넘', '다이아몬드', '마스터', '그랜드마스터', '챌린저')

    </select>

</mapper> 