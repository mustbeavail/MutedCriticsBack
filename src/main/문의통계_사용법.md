# 문의/신고 일일 통계 시스템 사용법

## 개요
문의/신고 일일 통계 시스템은 다음과 같은 기능을 제공합니다:
- 기간별 일일 통계 데이터 일괄 생성
- 문의/신고 상태 변경 시 자동 통계 업데이트
- 특정 날짜의 통계 수동 업데이트

## 데이터베이스 설정

### 1. 테이블 생성
```sql
-- create_inquiry_stats_table.sql 실행
CREATE TABLE `stats_inquiry_daily` (
    `inquiry_stats_id` BIGINT NOT NULL AUTO_INCREMENT,
    `stats_date` DATE NOT NULL,
    `ticket_type` VARCHAR(10) NOT NULL,
    `category` VARCHAR(50) NOT NULL,
    `daily_ticket_count` INT DEFAULT 0,
    `unresolved_total` INT DEFAULT 0,
    `vip_ticket_count` INT DEFAULT 0,
    PRIMARY KEY (`inquiry_stats_id`),
    UNIQUE KEY `uk_stats_date_type_category` (`stats_date`, `ticket_type`, `category`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

## API 사용법

### 1. 기간별 일일 통계 일괄 생성 (1월 1일 ~ 7월 5일)

**요청:**
```http
POST /inquiry/daily-stat-batch
Content-Type: application/x-www-form-urlencoded

startDate=2025-01-01&endDate=2025-07-05
```

**응답 예시:**
```json
{
    "success": true,
    "message": "기간별 일일 통계 데이터가 성공적으로 생성되었습니다.",
    "startDate": "2025-01-01",
    "endDate": "2025-07-05"
}
```

### 2. 특정 날짜의 일일 통계 수동 업데이트

**요청:**
```http
POST /inquiry/daily-stat
Content-Type: application/x-www-form-urlencoded

targetDate=2025-01-01
```

**응답 예시:**
```json
{
    "success": true,
    "message": "일일 통계 데이터가 성공적으로 업데이트되었습니다.",
    "targetDate": "2025-01-01"
}
```

## 자동 통계 업데이트

### 문의/신고 상태 변경 시 자동 업데이트
- 상담사가 문의/신고에 답변을 등록하면 상태가 "완료"로 변경됩니다
- 이때 자동으로 해당 문의/신고가 생성된 날짜의 통계가 업데이트됩니다
- 로그를 통해 자동 업데이트 상태를 확인할 수 있습니다

### 로그 예시
```
2025-01-08 10:30:15 INFO  - 문의/신고 상태 변경 감지 - ID: 123, 이전 상태: 미처리, 현재 상태: 완료
2025-01-08 10:30:15 INFO  - 일일 통계 자동 업데이트 시작: 2025-01-01
2025-01-08 10:30:15 INFO  - 일일 통계 자동 업데이트 완료: 2025-01-01
```

## 통계 데이터 구조

### stats_inquiry_daily 테이블
- `inquiry_stats_id`: 통계 ID (Primary Key)
- `stats_date`: 통계 날짜
- `ticket_type`: 티켓 유형 (문의, 신고)
- `category`: 카테고리 (게임, 결제, 계정 등)
- `daily_ticket_count`: 일일 티켓 수
- `unresolved_total`: 미처리 티켓 수
- `vip_ticket_count`: VIP 유저 티켓 수

### 통계 계산 로직
```sql
SELECT
    DATE(i.created_at) AS stats_date,
    i.type AS ticket_type,
    i.category AS category,
    COUNT(*) AS daily_ticket_count,
    SUM(CASE WHEN i.status = '미처리' THEN 1 ELSE 0 END) AS unresolved_total,
    SUM(CASE WHEN u.vip_yn = 1 THEN 1 ELSE 0 END) AS vip_ticket_count
FROM inquiry i
JOIN user u ON i.user_id = u.user_id
WHERE DATE(i.created_at) = '날짜'
GROUP BY i.type, i.category;
```

## 주의사항

1. **중복 데이터 방지**: `ON DUPLICATE KEY UPDATE`를 사용하여 중복 데이터를 방지합니다
2. **트랜잭션 처리**: 모든 통계 업데이트는 트랜잭션 내에서 처리됩니다
3. **예외 처리**: 통계 업데이트 실패가 메인 비즈니스 로직에 영향을 주지 않도록 처리됩니다
4. **성능 최적화**: 변경된 날짜의 통계만 업데이트하여 성능을 최적화합니다

## 문제 해결

### 통계 데이터가 업데이트되지 않는 경우
1. 로그를 확인하여 오류 메시지를 확인하세요
2. 데이터베이스 연결 상태를 확인하세요
3. 문의/신고 데이터의 created_at 필드가 올바른지 확인하세요

### 성능 이슈가 발생하는 경우
1. inquiry 테이블의 created_at 필드에 인덱스가 있는지 확인하세요
2. 대량 데이터 처리 시 배치 크기를 조정하세요
3. 데이터베이스 서버의 리소스 사용량을 모니터링하세요